<!DOCTYPE html>
<html lang="zh">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Agentç«¯æ¡å½¢ç æ‰«ææ¼”ç¤º</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
      }

      .container {
        max-width: 800px;
        margin: 0 auto;
        background: white;
        border-radius: 15px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        overflow: hidden;
      }

      .header {
        background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);
        color: white;
        padding: 30px;
        text-align: center;
      }

      .header h1 {
        font-size: 2.5em;
        margin-bottom: 10px;
      }

      .header p {
        font-size: 1.1em;
        opacity: 0.9;
      }

      .main {
        padding: 40px;
      }

      .scan-section {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 30px;
        margin-bottom: 30px;
        border: 2px dashed #dee2e6;
        text-align: center;
      }

      .scan-input {
        width: 100%;
        padding: 15px;
        font-size: 1.2em;
        border: 2px solid #ddd;
        border-radius: 8px;
        margin-bottom: 20px;
        text-align: center;
        background: white;
      }

      .scan-input:focus {
        outline: none;
        border-color: #4caf50;
        box-shadow: 0 0 10px rgba(76, 175, 80, 0.3);
      }

      .button {
        background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);
        color: white;
        border: none;
        padding: 12px 30px;
        font-size: 1em;
        border-radius: 6px;
        cursor: pointer;
        margin: 5px;
        transition: all 0.3s ease;
      }

      .button:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(76, 175, 80, 0.4);
      }

      .button.secondary {
        background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%);
      }

      .button.batch {
        background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
      }

      .result {
        margin-top: 20px;
        padding: 20px;
        border-radius: 8px;
        display: none;
      }

      .result.success {
        background: #d4edda;
        border: 1px solid #c3e6cb;
        color: #155724;
      }

      .result.error {
        background: #f8d7da;
        border: 1px solid #f5c6cb;
        color: #721c24;
      }

      .result.info {
        background: #d1ecf1;
        border: 1px solid #bee5eb;
        color: #0c5460;
      }

      .package-info {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-top: 20px;
      }

      .info-card {
        background: white;
        padding: 20px;
        border-radius: 8px;
        border-left: 4px solid #4caf50;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }

      .info-card h3 {
        color: #333;
        margin-bottom: 10px;
      }

      .info-card p {
        color: #666;
        margin: 5px 0;
      }

      .batch-section {
        margin-top: 30px;
      }

      .batch-codes {
        width: 100%;
        height: 120px;
        padding: 15px;
        border: 2px solid #ddd;
        border-radius: 8px;
        font-family: monospace;
        font-size: 1em;
        resize: vertical;
      }

      .status-badge {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 0.8em;
        font-weight: bold;
        text-transform: uppercase;
      }

      .status-prepared {
        background: #fff3cd;
        color: #856404;
      }

      .status-arrived {
        background: #d4edda;
        color: #155724;
      }

      .loading {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid #f3f3f3;
        border-top: 3px solid #4caf50;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>ğŸ“¦ Agentç«¯æ¡å½¢ç æ‰«æ</h1>
        <p>æ‰«æåŒ…è£¹æ¡å½¢ç ç¡®è®¤åˆ°ä»“ - TranSyncä»“åº“ç®¡ç†ç³»ç»Ÿ</p>
      </div>

      <div class="main">
        <!-- å•ä¸ªåŒ…è£¹æ‰«æ -->
        <div class="scan-section">
          <h2>ğŸ” æ‰«æåŒ…è£¹æ¡å½¢ç </h2>
          <p>å°†å…‰æ ‡ç½®äºè¾“å…¥æ¡†ï¼Œæ‰«ææ¡å½¢ç æˆ–æ‰‹åŠ¨è¾“å…¥åŒ…è£¹ç¼–å·</p>
          <input
            type="text"
            id="packageCodeInput"
            class="scan-input"
            placeholder="æ‰«ææ¡å½¢ç æˆ–è¾“å…¥åŒ…è£¹ç¼–å· (ä¾‹: IB0A001-250729A-001)"
            autofocus
          />
          <div>
            <button class="button" onclick="searchPackage()">
              ğŸ” æŸ¥è¯¢åŒ…è£¹
            </button>
            <button class="button" onclick="confirmPackage()">
              âœ… ç¡®è®¤åˆ°ä»“
            </button>
            <button class="button secondary" onclick="clearInput()">
              ğŸ—‘ï¸ æ¸…ç©º
            </button>
          </div>
        </div>

        <!-- ç»“æœæ˜¾ç¤º -->
        <div id="result" class="result"></div>

        <!-- åŒ…è£¹ä¿¡æ¯å¡ç‰‡ -->
        <div id="packageInfo" class="package-info" style="display: none"></div>

        <!-- æ‰¹é‡æ‰«æ -->
        <div class="batch-section">
          <h2>ğŸ“‹ æ‰¹é‡ç¡®è®¤åŒ…è£¹</h2>
          <p>ä¸€è¡Œä¸€ä¸ªåŒ…è£¹ç¼–å·ï¼Œæ”¯æŒæ‰¹é‡ç¡®è®¤</p>
          <textarea
            id="batchCodes"
            class="batch-codes"
            placeholder="è¾“å…¥å¤šä¸ªåŒ…è£¹ç¼–å·ï¼Œæ¯è¡Œä¸€ä¸ªï¼š&#10;IB0A001-250729A-001&#10;IB0A001-250729A-002&#10;IB0A001-250729A-003"
          ></textarea>
          <div>
            <button class="button batch" onclick="batchConfirm()">
              ğŸ“¦ æ‰¹é‡ç¡®è®¤
            </button>
            <button class="button secondary" onclick="clearBatch()">
              ğŸ—‘ï¸ æ¸…ç©º
            </button>
          </div>
        </div>
      </div>
    </div>

    <script>
      // é…ç½®
      const API_BASE = "/api/agent/packages";
      const TOKEN = localStorage.getItem("agentToken") || "YOUR_TOKEN_HERE";

      // å·¥å…·å‡½æ•°
      function showResult(message, type = "info") {
        const resultDiv = document.getElementById("result");
        resultDiv.className = `result ${type}`;
        resultDiv.innerHTML = message;
        resultDiv.style.display = "block";

        // 3ç§’åè‡ªåŠ¨éšè—
        setTimeout(() => {
          resultDiv.style.display = "none";
        }, 5000);
      }

      function showLoading(button) {
        const originalText = button.innerHTML;
        button.innerHTML = '<span class="loading"></span> å¤„ç†ä¸­...';
        button.disabled = true;

        return () => {
          button.innerHTML = originalText;
          button.disabled = false;
        };
      }

      async function apiRequest(url, options = {}) {
        try {
          const response = await fetch(url, {
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${TOKEN}`,
              ...options.headers,
            },
            ...options,
          });

          const data = await response.json();
          return { success: response.ok, status: response.status, data };
        } catch (error) {
          return { success: false, error: error.message };
        }
      }

      // æ˜¾ç¤ºåŒ…è£¹ä¿¡æ¯
      function displayPackageInfo(packageData) {
        const infoDiv = document.getElementById("packageInfo");
        const canConfirm = packageData.can_confirm_arrival;
        const status = packageData.status;

        infoDiv.innerHTML = `
                <div class="info-card">
                    <h3>ğŸ“¦ åŒ…è£¹ä¿¡æ¯</h3>
                    <p><strong>åŒ…è£¹ç¼–å·:</strong> ${
                      packageData.package_code
                    }</p>
                    <p><strong>çŠ¶æ€:</strong> <span class="status-badge status-${status}">${status}</span></p>
                    <p><strong>åˆ›å»ºæ—¶é—´:</strong> ${new Date(
                      packageData.created_at
                    ).toLocaleString()}</p>
                    ${
                      packageData.arrival_confirmed_at
                        ? `<p><strong>ç¡®è®¤æ—¶é—´:</strong> ${new Date(
                            packageData.arrival_confirmed_at
                          ).toLocaleString()}</p>`
                        : ""
                    }
                </div>
                <div class="info-card">
                    <h3>ğŸ¢ å®¢æˆ·ä¿¡æ¯</h3>
                    <p><strong>å…¬å¸åç§°:</strong> ${
                      packageData.client_company
                    }</p>
                    <p><strong>å…¥åº“å•å·:</strong> ${packageData.inbond_code}</p>
                    <p><strong>ç‰©å“æ•°é‡:</strong> ${
                      packageData.items_count
                    } ä»¶</p>
                </div>
                <div class="info-card">
                    <h3>ğŸ“ ç‰©ç†ä¿¡æ¯</h3>
                    <p><strong>é‡é‡:</strong> ${
                      packageData.weight_kg || "æœªè®¾å®š"
                    } kg</p>
                    <p><strong>å°ºå¯¸:</strong> ${
                      packageData.dimensions.length_cm || 0
                    } Ã— ${packageData.dimensions.width_cm || 0} Ã— ${
          packageData.dimensions.height_cm || 0
        } cm</p>
                    <p><strong>å¯ç¡®è®¤åˆ°ä»“:</strong> ${
                      canConfirm ? "âœ… æ˜¯" : "âŒ å¦"
                    }</p>
                </div>
            `;
        infoDiv.style.display = "grid";
      }

      // æœç´¢åŒ…è£¹
      async function searchPackage() {
        const packageCode = document
          .getElementById("packageCodeInput")
          .value.trim();
        if (!packageCode) {
          showResult("âŒ è¯·è¾“å…¥åŒ…è£¹ç¼–å·", "error");
          return;
        }

        const result = await apiRequest(`${API_BASE}/search/${packageCode}`);

        if (result.success) {
          showResult(`âœ… æ‰¾åˆ°åŒ…è£¹: ${packageCode}`, "success");
          displayPackageInfo(result.data.package);
        } else {
          showResult(
            `âŒ æœç´¢å¤±è´¥: ${result.data?.error || result.error}`,
            "error"
          );
          document.getElementById("packageInfo").style.display = "none";
        }
      }

      // ç¡®è®¤åŒ…è£¹åˆ°ä»“
      async function confirmPackage() {
        const packageCode = document
          .getElementById("packageCodeInput")
          .value.trim();
        if (!packageCode) {
          showResult("âŒ è¯·è¾“å…¥åŒ…è£¹ç¼–å·", "error");
          return;
        }

        const button = event.target;
        const hideLoading = showLoading(button);

        const result = await apiRequest(`${API_BASE}/confirm-arrival`, {
          method: "POST",
          body: JSON.stringify({
            package_code: packageCode,
            arrival_note: `é€šè¿‡Webç•Œé¢ç¡®è®¤åŒ…è£¹ ${packageCode} åˆ°ä»“`,
          }),
        });

        hideLoading();

        if (result.success) {
          showResult(`ğŸ‰ åŒ…è£¹ ${packageCode} å·²æˆåŠŸç¡®è®¤åˆ°ä»“ï¼`, "success");
          // é‡æ–°æœç´¢ä»¥æ›´æ–°æ˜¾ç¤ºä¿¡æ¯
          setTimeout(() => searchPackage(), 1000);
        } else {
          showResult(
            `âŒ ç¡®è®¤å¤±è´¥: ${result.data?.error || result.error}`,
            "error"
          );
        }
      }

      // æ‰¹é‡ç¡®è®¤
      async function batchConfirm() {
        const batchText = document.getElementById("batchCodes").value.trim();
        if (!batchText) {
          showResult("âŒ è¯·è¾“å…¥åŒ…è£¹ç¼–å·", "error");
          return;
        }

        const packageCodes = batchText
          .split("\n")
          .map((line) => line.trim())
          .filter((line) => line.length > 0);

        if (packageCodes.length === 0) {
          showResult("âŒ æ²¡æœ‰æœ‰æ•ˆçš„åŒ…è£¹ç¼–å·", "error");
          return;
        }

        const button = event.target;
        const hideLoading = showLoading(button);

        const result = await apiRequest(`${API_BASE}/confirm-arrival-batch`, {
          method: "POST",
          body: JSON.stringify({
            package_codes: packageCodes,
            arrival_note: `é€šè¿‡Webç•Œé¢æ‰¹é‡ç¡®è®¤ ${packageCodes.length} ä¸ªåŒ…è£¹åˆ°ä»“`,
          }),
        });

        hideLoading();

        if (result.success) {
          const summary = result.data.summary;
          let message = `ğŸ‰ æ‰¹é‡ç¡®è®¤å®Œæˆï¼<br>`;
          message += `âœ… æˆåŠŸ: ${summary.total_confirmed}ä¸ª<br>`;
          message += `âŒ å¤±è´¥: ${summary.total_failed}ä¸ª<br>`;

          if (result.data.errors && result.data.errors.length > 0) {
            message += `<br><strong>é”™è¯¯è¯¦æƒ…:</strong><br>`;
            result.data.errors.forEach((error) => {
              message += `â€¢ ${error.package_code}: ${error.error}<br>`;
            });
          }

          showResult(message, summary.total_failed > 0 ? "info" : "success");
        } else {
          showResult(
            `âŒ æ‰¹é‡ç¡®è®¤å¤±è´¥: ${result.data?.error || result.error}`,
            "error"
          );
        }
      }

      // æ¸…ç©ºè¾“å…¥
      function clearInput() {
        document.getElementById("packageCodeInput").value = "";
        document.getElementById("packageInfo").style.display = "none";
        document.getElementById("result").style.display = "none";
      }

      function clearBatch() {
        document.getElementById("batchCodes").value = "";
      }

      // æ¡å½¢ç æ‰«æç›‘å¬
      let scanBuffer = [];
      let lastScanTime = 0;

      document.addEventListener("keydown", function (e) {
        const now = Date.now();

        // å¦‚æœè·ç¦»ä¸Šæ¬¡è¾“å…¥è¶…è¿‡200msï¼Œæ¸…ç©ºç¼“å†²åŒºï¼ˆæ–°çš„æ‰«æå¼€å§‹ï¼‰
        if (now - lastScanTime > 200) {
          scanBuffer = [];
        }

        lastScanTime = now;

        if (e.key === "Enter" && scanBuffer.length > 5) {
          // æ¡å½¢ç æ‰«æå®Œæˆ
          const scannedCode = scanBuffer.join("");
          document.getElementById("packageCodeInput").value = scannedCode;
          scanBuffer = [];

          // è‡ªåŠ¨æœç´¢åŒ…è£¹
          searchPackage();

          e.preventDefault();
        } else if (
          e.key.length === 1 &&
          document.activeElement === document.getElementById("packageCodeInput")
        ) {
          // æ”¶é›†æ‰«æå­—ç¬¦
          scanBuffer.push(e.key);
        }
      });

      // é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
      document.addEventListener("DOMContentLoaded", function () {
        // æ£€æŸ¥æ˜¯å¦æœ‰ä¿å­˜çš„Token
        if (TOKEN === "YOUR_TOKEN_HERE") {
          showResult(
            'âš ï¸ è¯·å…ˆè®¾ç½®Agentè®¤è¯ä»¤ç‰Œã€‚åœ¨æµè§ˆå™¨æ§åˆ¶å°æ‰§è¡Œ: localStorage.setItem("agentToken", "æ‚¨çš„JWTä»¤ç‰Œ")',
            "error"
          );
        }

        // èšç„¦åˆ°è¾“å…¥æ¡†
        document.getElementById("packageCodeInput").focus();

        console.log("ğŸ¯ Agentç«¯æ¡å½¢ç æ‰«æç³»ç»Ÿå·²å¯åŠ¨");
        console.log("ğŸ’¡ ä½¿ç”¨æç¤º:");
        console.log(
          '  1. è®¾ç½®Token: localStorage.setItem("agentToken", "æ‚¨çš„JWTä»¤ç‰Œ")'
        );
        console.log("  2. å°†å…‰æ ‡ç½®äºè¾“å…¥æ¡†ï¼Œç›´æ¥æ‰«ææ¡å½¢ç ");
        console.log("  3. æ‰«æåä¼šè‡ªåŠ¨æœç´¢åŒ…è£¹ä¿¡æ¯");
        console.log('  4. ç‚¹å‡»"ç¡®è®¤åˆ°ä»“"æŒ‰é’®å®Œæˆç¡®è®¤');
      });
    </script>
  </body>
</html>
